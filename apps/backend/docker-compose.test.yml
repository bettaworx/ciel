name: ciel-backend-test

services:
  db_test:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ciel
      POSTGRES_USER: ciel
      POSTGRES_PASSWORD: ciel
    # No host port; only used inside this compose network.
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ciel -d ciel"]
      interval: 2s
      timeout: 2s
      retries: 30
    # Fresh DB each run without needing `down -v` (keeps Go module caches intact).
    tmpfs:
      - /var/lib/postgresql/data
    volumes:
      # Schema + migrations (executed only when DB is empty).
      - ./db/schema.sql:/docker-entrypoint-initdb.d/001_schema.sql:ro
      - ./db/migrations/002_add_media_ext.sql:/docker-entrypoint-initdb.d/002_add_media_ext.sql:ro
      - ./db/migrations/003_add_authz.sql:/docker-entrypoint-initdb.d/003_add_authz.sql:ro

  redis_test:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 2s
      retries: 30

  backend_test:
    image: golang:1.25-alpine
    working_dir: /src
    depends_on:
      db_test:
        condition: service_healthy
      redis_test:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://ciel:ciel@db_test:5432/ciel?sslmode=disable
      REDIS_ADDR: redis_test:6379
      JWT_SECRET: test-secret-test-secret-test-secret-32b
      MEDIA_DIR: /tmp/ciel-media
      # keep behavior consistent with local.
      TRUST_PROXY: "0"
    volumes:
      - ./:/src
      - gomodcache:/go/pkg/mod
      - gobuildcache:/root/.cache/go-build
    # Media integration tests require ffmpeg/ffprobe.
    command: ["sh", "-c", "apk add --no-cache ffmpeg >/dev/null 2>&1; go test ./tests/... -count=1 -tags=integration"]

volumes:
  gomodcache:
  gobuildcache:
